{#
  Security & Compliance Deep Section (CTO Persona - AC-4.1.10)
  Updated for Story 4-4 to use scenarioData.security_posture

  Variables:
  - scenarioData: Scenario data from scenarios.yaml (includes security_posture)
  - cto_evaluation: Legacy CTO-specific evaluation data (fallback)
#}

<div class="ndx-evidence-pack__section">
  <h2 class="govuk-heading-l ndx-evidence-pack__section-title">
    Security & Compliance
  </h2>

  {% include "evidence-pack/partials/persona-header.njk" %}

  {% if scenarioData and scenarioData.security_posture %}
  {# Story 4-4: Use security_posture from scenarios.yaml #}
  {% set security = scenarioData.security_posture %}

  <h3 class="govuk-heading-m">Data Residency & Sovereignty</h3>
  <div class="govuk-inset-text">
    <p class="govuk-body">
      <strong>{{ security.data_residency }}</strong>
    </p>
    <p class="govuk-body">
      All data remains within the UK, meeting UK data sovereignty and GDPR requirements.
    </p>
  </div>

  <h3 class="govuk-heading-m">Encryption</h3>
  <p class="govuk-body">{{ security.encryption }}</p>

  <dl class="govuk-summary-list">
    <div class="govuk-summary-list__row">
      <dt class="govuk-summary-list__key">
        Data at Rest
      </dt>
      <dd class="govuk-summary-list__value">
        AES-256 encryption (S3, DynamoDB)
      </dd>
    </div>
    <div class="govuk-summary-list__row">
      <dt class="govuk-summary-list__key">
        Data in Transit
      </dt>
      <dd class="govuk-summary-list__value">
        TLS 1.3 for all API communications
      </dd>
    </div>
    <div class="govuk-summary-list__row">
      <dt class="govuk-summary-list__key">
        Key Management
      </dt>
      <dd class="govuk-summary-list__value">
        AWS KMS with automatic key rotation
      </dd>
    </div>
  </dl>

  <h3 class="govuk-heading-m">Data Handling</h3>
  <p class="govuk-body">{{ security.data_handling }}</p>

  <div class="govuk-warning-text">
    <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
    <strong class="govuk-warning-text__text">
      <span class="govuk-visually-hidden">Warning</span>
      Production deployment requires Multi-Factor Authentication (MFA) for all IAM users with administrative access.
    </strong>
  </div>

  <h3 class="govuk-heading-m">AWS Certifications & Compliance</h3>
  <p class="govuk-body">
    AWS holds certifications that support council compliance requirements:
  </p>
  {% if security.certifications %}
  <ul class="govuk-list govuk-list--bullet">
    {% for cert in security.certifications %}
      <li>{{ cert }}</li>
    {% endfor %}
  </ul>
  {% else %}
  <ul class="govuk-list govuk-list--bullet">
    <li>ISO 27001 (Information Security Management)</li>
    <li>ISO 27017 (Cloud Security)</li>
    <li>ISO 27018 (Cloud Privacy)</li>
    <li>SOC 1, SOC 2, SOC 3 Reports</li>
    <li>UK Cyber Essentials Plus</li>
    <li>UK Government G-Cloud Framework</li>
  </ul>
  {% endif %}

  <h3 class="govuk-heading-m">Shared Responsibility Model</h3>
  <p class="govuk-body">
    Security and compliance is a shared responsibility between AWS and the council:
  </p>

  <div class="govuk-grid-row govuk-!-margin-bottom-6">
    <div class="govuk-grid-column-one-half">
      <div class="govuk-panel govuk-panel--confirmation" style="background-color: #f3f2f1;">
        <h4 class="govuk-panel__title" style="color: #0b0c0c;">
          AWS Manages
        </h4>
        <div class="govuk-panel__body" style="color: #0b0c0c;">
          <ul class="govuk-list govuk-list--bullet" style="text-align: left; margin-left: 20px;">
            <li style="color: #0b0c0c;">Infrastructure security</li>
            <li style="color: #0b0c0c;">Physical data centers</li>
            <li style="color: #0b0c0c;">Network security</li>
            <li style="color: #0b0c0c;">Hypervisor isolation</li>
            <li style="color: #0b0c0c;">Managed service patching</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="govuk-grid-column-one-half">
      <div class="govuk-panel" style="border: 2px solid #0b0c0c; background-color: #fff;">
        <h4 class="govuk-panel__title" style="color: #0b0c0c;">
          Council Manages
        </h4>
        <div class="govuk-panel__body" style="color: #0b0c0c;">
          <ul class="govuk-list govuk-list--bullet" style="text-align: left; margin-left: 20px;">
            <li style="color: #0b0c0c;">Data classification</li>
            <li style="color: #0b0c0c;">Application security</li>
            <li style="color: #0b0c0c;">User access management</li>
            <li style="color: #0b0c0c;">Content accuracy</li>
            <li style="color: #0b0c0c;">Encryption configuration</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <h3 class="govuk-heading-m">Security Best Practices Implemented</h3>
  <ul class="govuk-list govuk-list--bullet">
    <li>Least privilege IAM policies for all roles and users</li>
    <li>Encryption at rest and in transit for all data</li>
    <li>VPC isolation where applicable</li>
    <li>CloudTrail logging enabled for audit trail</li>
    <li>CloudWatch monitoring and alerting configured</li>
    <li>AWS Config for compliance monitoring</li>
    <li>Regular automated security patching for managed services</li>
  </ul>

  <h3 class="govuk-heading-m">Data Protection Impact Assessment (DPIA)</h3>
  <div class="govuk-inset-text">
    <p class="govuk-body">
      <strong>Recommendation:</strong> Conduct a Data Protection Impact Assessment (DPIA) before production deployment, involving:
    </p>
    <ul class="govuk-list govuk-list--bullet">
      <li>Data Protection Officer (DPO) review</li>
      <li>Privacy impact assessment</li>
      <li>Data flow mapping</li>
      <li>Retention policy definition</li>
      <li>Subject access request procedures</li>
    </ul>
  </div>

  <h3 class="govuk-heading-m">Compliance Frameworks</h3>
  <p class="govuk-body">
    This solution can support compliance with:
  </p>
  <ul class="govuk-list govuk-list--bullet">
    <li><strong>GDPR:</strong> Data protection and privacy controls</li>
    <li><strong>UK Data Protection Act 2018:</strong> UK-specific data handling requirements</li>
    <li><strong>Cyber Essentials Plus:</strong> UK government security baseline</li>
    <li><strong>PSN (Public Services Network):</strong> Government network security standards</li>
    <li><strong>ISO 27001:</strong> Information security management system</li>
  </ul>

  <div class="govuk-warning-text">
    <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
    <strong class="govuk-warning-text__text">
      <span class="govuk-visually-hidden">Important</span>
      Compliance certification requires formal assessment by your council's security and legal teams. This evaluation provides a foundation for those discussions.
    </strong>
  </div>

  {% elif cto_evaluation and cto_evaluation.security_compliance %}
  {# Fallback to legacy cto_evaluation.security_compliance structure #}
  {% set security = cto_evaluation.security_compliance %}

  <h3 class="govuk-heading-m">Data Residency & Sovereignty</h3>
  <div class="govuk-inset-text">
    <p class="govuk-body">
      <strong>{{ security.data_residency }}</strong>
    </p>
    <p class="govuk-body">
      All data remains within the UK, meeting UK data sovereignty and GDPR requirements.
    </p>
  </div>

  <h3 class="govuk-heading-m">Encryption</h3>
  <p class="govuk-body">{{ security.encryption }}</p>

  <dl class="govuk-summary-list">
    <div class="govuk-summary-list__row">
      <dt class="govuk-summary-list__key">
        Data at Rest
      </dt>
      <dd class="govuk-summary-list__value">
        AES-256 encryption (S3, DynamoDB)
      </dd>
    </div>
    <div class="govuk-summary-list__row">
      <dt class="govuk-summary-list__key">
        Data in Transit
      </dt>
      <dd class="govuk-summary-list__value">
        TLS 1.3 for all API communications
      </dd>
    </div>
    <div class="govuk-summary-list__row">
      <dt class="govuk-summary-list__key">
        Key Management
      </dt>
      <dd class="govuk-summary-list__value">
        AWS KMS with automatic key rotation
      </dd>
    </div>
  </dl>

  <h3 class="govuk-heading-m">Access Control</h3>
  <p class="govuk-body">{{ security.access_control }}</p>

  <div class="govuk-warning-text">
    <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
    <strong class="govuk-warning-text__text">
      <span class="govuk-visually-hidden">Warning</span>
      Production deployment requires Multi-Factor Authentication (MFA) for all IAM users with administrative access.
    </strong>
  </div>

  <h3 class="govuk-heading-m">Compliance Frameworks</h3>
  {% if security.compliance_frameworks %}
  <ul class="govuk-list govuk-list--bullet">
    {% for framework in security.compliance_frameworks %}
      <li>{{ framework }}</li>
    {% endfor %}
  </ul>
  {% endif %}

  <h3 class="govuk-heading-m">AWS Certifications</h3>
  <p class="govuk-body">
    AWS holds certifications that support council compliance requirements:
  </p>
  <ul class="govuk-list govuk-list--bullet">
    <li>ISO 27001 (Information Security Management)</li>
    <li>ISO 27017 (Cloud Security)</li>
    <li>ISO 27018 (Cloud Privacy)</li>
    <li>SOC 1, SOC 2, SOC 3 Reports</li>
    <li>UK Cyber Essentials Plus</li>
    <li>UK Government G-Cloud Framework</li>
  </ul>

  <h3 class="govuk-heading-m">Shared Responsibility Model</h3>
  <p class="govuk-body">
    Security and compliance is a shared responsibility between AWS and the council:
  </p>

  <div class="govuk-grid-row govuk-!-margin-bottom-6">
    <div class="govuk-grid-column-one-half">
      <div class="govuk-panel govuk-panel--confirmation" style="background-color: #f3f2f1;">
        <h4 class="govuk-panel__title" style="color: #0b0c0c;">
          AWS Manages
        </h4>
        <div class="govuk-panel__body" style="color: #0b0c0c;">
          <ul class="govuk-list govuk-list--bullet" style="text-align: left; margin-left: 20px;">
            {% for item in security.shared_responsibility.aws_manages %}
              <li style="color: #0b0c0c;">{{ item }}</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>

    <div class="govuk-grid-column-one-half">
      <div class="govuk-panel" style="border: 2px solid #0b0c0c; background-color: #fff;">
        <h4 class="govuk-panel__title" style="color: #0b0c0c;">
          Council Manages
        </h4>
        <div class="govuk-panel__body" style="color: #0b0c0c;">
          <ul class="govuk-list govuk-list--bullet" style="text-align: left; margin-left: 20px;">
            {% for item in security.shared_responsibility.council_manages %}
              <li style="color: #0b0c0c;">{{ item }}</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>

  <h3 class="govuk-heading-m">Security Best Practices Implemented</h3>
  <ul class="govuk-list govuk-list--bullet">
    <li>Least privilege IAM policies for all roles and users</li>
    <li>Encryption at rest and in transit for all data</li>
    <li>VPC isolation where applicable</li>
    <li>CloudTrail logging enabled for audit trail</li>
    <li>CloudWatch monitoring and alerting configured</li>
    <li>AWS Config for compliance monitoring</li>
    <li>Regular automated security patching for managed services</li>
  </ul>

  <h3 class="govuk-heading-m">Data Protection Impact Assessment (DPIA)</h3>
  <div class="govuk-inset-text">
    <p class="govuk-body">
      <strong>Recommendation:</strong> Conduct a Data Protection Impact Assessment (DPIA) before production deployment, involving:
    </p>
    <ul class="govuk-list govuk-list--bullet">
      <li>Data Protection Officer (DPO) review</li>
      <li>Privacy impact assessment</li>
      <li>Data flow mapping</li>
      <li>Retention policy definition</li>
      <li>Subject access request procedures</li>
    </ul>
  </div>

  {% else %}
  <p class="govuk-body">
    Detailed security and compliance information will be available after completing the technical evaluation.
  </p>
  {% endif %}
</div>
