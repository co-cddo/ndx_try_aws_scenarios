<?xml version="1.0" encoding="UTF-8"?>
<!--
  Story Context: S0.3 - Screenshot Capture Pipeline
  Generated: 2025-11-29
  Sprint: Sprint 0 - Screenshot Automation Infrastructure
-->
<story-context>
  <metadata>
    <story-id>S0.3</story-id>
    <story-key>s0-3-screenshot-capture-pipeline</story-key>
    <story-title>Screenshot Capture Pipeline</story-title>
    <epic-id>sprint-0</epic-id>
    <points>8</points>
    <generated>2025-11-29</generated>
    <prerequisites>
      <prerequisite status="done">S0.1 - AWS Federation Service Account Setup</prerequisite>
      <prerequisite status="done">S0.2 - Playwright Integration Library</prerequisite>
    </prerequisites>
  </metadata>

  <user-story>
    <as-a>content maintainer updating portal documentation</as-a>
    <i-want>a GitHub Actions workflow that captures AWS Console screenshots automatically</i-want>
    <so-that>documentation screenshots stay current without manual screenshot capture</so-that>
  </user-story>

  <acceptance-criteria>
    <criterion id="AC3.1" status="pending">
      <description>GitHub Actions workflow `.github/workflows/screenshot-capture.yml` processes all 6 scenarios sequentially</description>
      <test-approach>Verify workflow file exists with correct job structure</test-approach>
    </criterion>
    <criterion id="AC3.2" status="pending">
      <description>Captures minimum 15 screenshots per scenario using S0.2 library</description>
      <test-approach>Run workflow and verify 90+ screenshots captured total</test-approach>
    </criterion>
    <criterion id="AC3.3" status="pending">
      <description>Uploads screenshots to S3 bucket with versioning enabled</description>
      <test-approach>Verify S3 bucket configuration and upload functionality</test-approach>
    </criterion>
    <criterion id="AC3.4" status="pending">
      <description>Generates JSON manifest with metadata (timestamp, scenario, page, dimensions)</description>
      <test-approach>Unit test manifest generation; integration test S3 manifest upload</test-approach>
    </criterion>
    <criterion id="AC3.5" status="pending">
      <description>Sends SNS notification on completion or failure</description>
      <test-approach>Verify SNS publish call with correct message format</test-approach>
    </criterion>
    <criterion id="AC3.6" status="pending">
      <description>Completes full batch within 30 minutes (NFR52)</description>
      <test-approach>Monitor workflow execution time; timeout configuration</test-approach>
    </criterion>
    <criterion id="AC3.7" status="pending">
      <description>Supports manual invocation via workflow_dispatch with scenario selector</description>
      <test-approach>Verify workflow_dispatch trigger with inputs defined</test-approach>
    </criterion>
    <criterion id="AC3.8" status="pending">
      <description>Supports scheduled weekly runs (Saturday 03:00 UTC)</description>
      <test-approach>Verify schedule trigger in workflow file</test-approach>
    </criterion>
    <criterion id="AC3.9" status="pending">
      <description>Supports post-deployment trigger after CloudFormation template changes</description>
      <test-approach>Verify push trigger with path filter for cloudformation/</test-approach>
    </criterion>
    <criterion id="AC3.10" status="pending">
      <description>Implements retry logic (3 retries, 5-second delays) for failed page loads</description>
      <test-approach>Unit test retry helper; integration test with slow pages</test-approach>
    </criterion>
    <criterion id="AC3.11" status="pending">
      <description>Implements circuit breaker: halt if >50% screenshots fail in batch</description>
      <test-approach>Unit test circuit breaker logic</test-approach>
    </criterion>
  </acceptance-criteria>

  <tasks>
    <task id="1" description="Create S3 bucket CloudFormation template">
      <subtask id="1.1">Create cloudformation/screenshot-automation/s3-bucket.yaml</subtask>
      <subtask id="1.2">Define S3 bucket with versioning enabled</subtask>
      <subtask id="1.3">Configure lifecycle rules (10 versions, 90-day Glacier)</subtask>
      <subtask id="1.4">Add bucket policy for GitHub Actions access</subtask>
      <subtask id="1.5">Output bucket name and ARN</subtask>
    </task>
    <task id="2" description="Create SNS notification infrastructure">
      <subtask id="2.1">Add SNS topic to CloudFormation template</subtask>
      <subtask id="2.2">Configure topic policy for GitHub Actions publishing</subtask>
      <subtask id="2.3">Output topic ARN</subtask>
    </task>
    <task id="3" description="Create screenshot capture Playwright tests">
      <subtask id="3.1">Create tests/e2e/console-screenshots/ directory</subtask>
      <subtask id="3.2">Create base screenshot test helper with retry</subtask>
      <subtask id="3.3">Create council-chatbot.spec.ts</subtask>
      <subtask id="3.4">Create planning-ai.spec.ts</subtask>
      <subtask id="3.5">Create foi-redaction.spec.ts</subtask>
      <subtask id="3.6">Create smart-car-park.spec.ts</subtask>
      <subtask id="3.7">Create text-to-speech.spec.ts</subtask>
      <subtask id="3.8">Create quicksight.spec.ts</subtask>
    </task>
    <task id="4" description="Create manifest generation utility">
      <subtask id="4.1">Create src/lib/screenshot-manifest.ts</subtask>
      <subtask id="4.2">Define ScreenshotManifest interface</subtask>
      <subtask id="4.3">Implement manifest generation function</subtask>
      <subtask id="4.4">Implement S3 upload function</subtask>
    </task>
    <task id="5" description="Create circuit breaker logic">
      <subtask id="5.1">Create src/lib/circuit-breaker.ts</subtask>
      <subtask id="5.2">Implement failure tracking per batch</subtask>
      <subtask id="5.3">Implement 50% threshold check</subtask>
    </task>
    <task id="6" description="Create GitHub Actions workflow">
      <subtask id="6.1">Create .github/workflows/screenshot-capture.yml</subtask>
      <subtask id="6.2">Add workflow_dispatch with scenario input</subtask>
      <subtask id="6.3">Add schedule trigger (Saturday 03:00 UTC)</subtask>
      <subtask id="6.4">Add push trigger for CloudFormation changes</subtask>
      <subtask id="6.5">Configure AWS credentials from secrets</subtask>
      <subtask id="6.6">Run screenshot tests per scenario</subtask>
      <subtask id="6.7">Upload manifest to S3</subtask>
      <subtask id="6.8">Send SNS notification</subtask>
    </task>
    <task id="7" description="Write unit tests">
      <subtask id="7.1">Create tests/unit/screenshot-manifest.test.ts</subtask>
      <subtask id="7.2">Create tests/unit/circuit-breaker.test.ts</subtask>
    </task>
  </tasks>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-sprint-0.md</path>
        <title>Sprint 0 Technical Specification</title>
        <section>S0.3 Acceptance Criteria, Workflows</section>
        <snippet>Defines screenshot capture pipeline workflow, manifest schema, circuit breaker requirements.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/s0-2-playwright-integration-library.md</path>
        <title>S0.2 Story (Prerequisite)</title>
        <section>Dev Agent Record, API Design</section>
        <snippet>aws-federation.ts API available: openAwsConsoleInPlaywright, closeConsoleSession, buildConsoleUrl, getStackOutputs.</snippet>
      </doc>
    </docs>

    <code>
      <file>
        <path>src/lib/aws-federation.ts</path>
        <kind>library</kind>
        <symbol>openAwsConsoleInPlaywright, closeConsoleSession, buildConsoleUrl, getStackOutputs</symbol>
        <reason>S0.2 library used for authenticated console access in screenshot tests</reason>
      </file>
      <file>
        <path>cloudformation/screenshot-automation/iam.yaml</path>
        <kind>cloudformation-template</kind>
        <symbol>FederationTokenPolicy</symbol>
        <reason>IAM policy defining what the screenshot automation can access</reason>
      </file>
      <file>
        <path>playwright.config.ts</path>
        <kind>config</kind>
        <symbol>defineConfig</symbol>
        <reason>Playwright configuration for screenshot tests</reason>
      </file>
      <file>
        <path>tests/e2e/federation-flow.spec.ts</path>
        <kind>test</kind>
        <symbol>test.describe</symbol>
        <reason>Pattern for E2E tests using federation library</reason>
      </file>
      <file>
        <path>vitest.config.ts</path>
        <kind>config</kind>
        <symbol>defineConfig</symbol>
        <reason>Test configuration for unit tests</reason>
      </file>
    </code>

    <dependencies>
      <npm>
        <package name="@aws-sdk/client-s3" version="^3.600.0" dev="true" required="true">S3 screenshot upload - TO BE ADDED</package>
        <package name="@aws-sdk/client-sns" version="^3.600.0" dev="true" required="true">SNS notifications - TO BE ADDED</package>
        <package name="@aws-sdk/client-sts" version="^3.600.0" dev="true">STS GetFederationToken - AVAILABLE</package>
        <package name="@aws-sdk/client-cloudformation" version="^3.600.0" dev="true">CloudFormation DescribeStacks - AVAILABLE</package>
        <package name="axios" version="^1.6.0" dev="true">HTTP client - AVAILABLE</package>
        <package name="@playwright/test" version="^1.49.0" dev="true">Browser automation - AVAILABLE</package>
        <package name="vitest" version="^1.0.0" dev="true">Unit testing - AVAILABLE</package>
      </npm>
    </dependencies>
  </artifacts>

  <interfaces>
    <interface>
      <name>ScreenshotManifest</name>
      <kind>TypeScript interface</kind>
      <signature>
        interface ScreenshotManifest {
          batch_id: string;
          timestamp: string;
          duration_seconds: number;
          scenarios: ScenarioCapture[];
        }
      </signature>
      <path>src/lib/screenshot-manifest.ts</path>
    </interface>
    <interface>
      <name>ScenarioCapture</name>
      <kind>TypeScript interface</kind>
      <signature>
        interface ScenarioCapture {
          scenario_name: string;
          status: 'success' | 'partial' | 'failed';
          screenshots: ScreenshotMetadata[];
          errors?: string[];
        }
      </signature>
      <path>src/lib/screenshot-manifest.ts</path>
    </interface>
    <interface>
      <name>ScreenshotMetadata</name>
      <kind>TypeScript interface</kind>
      <signature>
        interface ScreenshotMetadata {
          page: string;
          filename: string;
          dimensions: { width: number; height: number };
          size_bytes: number;
          timestamp: string;
          cfn_template_version?: string;
        }
      </signature>
      <path>src/lib/screenshot-manifest.ts</path>
    </interface>
    <interface>
      <name>CircuitBreaker</name>
      <kind>class</kind>
      <signature>
        class CircuitBreaker {
          constructor(threshold: number);
          recordSuccess(): void;
          recordFailure(): void;
          isOpen(): boolean;
          getStats(): { total: number; failures: number; rate: number };
        }
      </signature>
      <path>src/lib/circuit-breaker.ts</path>
    </interface>
  </interfaces>

  <constraints>
    <constraint source="NFR51">95%+ screenshot capture success rate</constraint>
    <constraint source="NFR52">30-minute full batch completion (6 scenarios Ã— 15 screenshots)</constraint>
    <constraint source="NFR53">S3 retention: 10 versions, 90-day Glacier transition</constraint>
    <constraint source="tech-spec">Circuit breaker halts batch if >50% screenshots fail</constraint>
    <constraint source="tech-spec">Retry logic: 3 retries, 5-second delays</constraint>
    <constraint source="tech-spec">Sequential scenario processing (not parallel)</constraint>
    <constraint source="tech-spec">Screenshots captured via Playwright E2E tests</constraint>
  </constraints>

  <tests>
    <standards>
      Unit tests use Vitest. E2E tests use Playwright.
      Mock AWS SDK for unit tests. Integration tests require actual AWS credentials.
      Follow test structure from tests/unit/aws-federation.test.ts.
    </standards>
    <locations>
      <location>tests/unit/screenshot-manifest.test.ts</location>
      <location>tests/unit/circuit-breaker.test.ts</location>
      <location>tests/e2e/console-screenshots/*.spec.ts</location>
    </locations>
    <ideas>
      <idea ac="AC3.4">Test manifest generation with various screenshot metadata</idea>
      <idea ac="AC3.11">Test circuit breaker triggers at exactly 50% failure</idea>
      <idea ac="AC3.10">Test retry logic with simulated failures</idea>
      <idea ac="AC3.3">Test S3 upload with mock client</idea>
      <idea ac="AC3.5">Test SNS notification message format</idea>
    </ideas>
  </tests>

  <files-to-create>
    <file>cloudformation/screenshot-automation/s3-bucket.yaml</file>
    <file>src/lib/screenshot-manifest.ts</file>
    <file>src/lib/circuit-breaker.ts</file>
    <file>.github/workflows/screenshot-capture.yml</file>
    <file>tests/unit/screenshot-manifest.test.ts</file>
    <file>tests/unit/circuit-breaker.test.ts</file>
    <file>tests/e2e/console-screenshots/screenshot-helper.ts</file>
    <file>tests/e2e/console-screenshots/council-chatbot.spec.ts</file>
    <file>tests/e2e/console-screenshots/planning-ai.spec.ts</file>
    <file>tests/e2e/console-screenshots/foi-redaction.spec.ts</file>
    <file>tests/e2e/console-screenshots/smart-car-park.spec.ts</file>
    <file>tests/e2e/console-screenshots/text-to-speech.spec.ts</file>
    <file>tests/e2e/console-screenshots/quicksight.spec.ts</file>
  </files-to-create>

  <files-to-modify>
    <file reason="Add @aws-sdk/client-s3 and @aws-sdk/client-sns dependencies">package.json</file>
  </files-to-modify>

  <previous-story-learnings>
    <source>docs/sprint-artifacts/s0-2-playwright-integration-library.md</source>
    <status>done</status>
    <new-files>
      <file>src/lib/aws-federation.ts</file>
      <file>tests/unit/aws-federation.test.ts</file>
      <file>tests/e2e/federation-flow.spec.ts</file>
    </new-files>
    <new-services>
      <service>AWS Console Federation via STS + SigninToken</service>
      <service>Playwright browser automation for AWS Console</service>
    </new-services>
    <architectural-decisions>
      <decision>Use error codes only (never log credentials)</decision>
      <decision>Clear credentials from memory after session close</decision>
      <decision>Retry logic with exponential backoff (1s, 2s, 4s)</decision>
    </architectural-decisions>
    <testing-patterns>
      <pattern>Mock AWS SDK and axios for unit tests</pattern>
      <pattern>Skip E2E tests if credentials not available</pattern>
      <pattern>Use describe blocks per acceptance criterion</pattern>
    </testing-patterns>
    <api-available>
      <function>openAwsConsoleInPlaywright(config, destination) - Opens authenticated console</function>
      <function>closeConsoleSession(response) - Closes browser, clears credentials</function>
      <function>buildConsoleUrl(arn, service, region) - Builds console URL from ARN</function>
      <function>getStackOutputs(stackName, region) - Gets CloudFormation outputs</function>
    </api-available>
  </previous-story-learnings>
</story-context>
