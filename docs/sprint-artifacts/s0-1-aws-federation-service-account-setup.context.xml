<?xml version="1.0" encoding="UTF-8"?>
<!--
  Story Context: S0.1 - AWS Federation Service Account Setup
  Generated: 2025-11-29
  Sprint: Sprint 0 - Screenshot Automation Infrastructure
-->
<story-context>
  <metadata>
    <story-id>S0.1</story-id>
    <story-key>s0-1-aws-federation-service-account-setup</story-key>
    <story-title>AWS Federation Service Account Setup</story-title>
    <epic-id>sprint-0</epic-id>
    <points>5</points>
    <generated>2025-11-29</generated>
  </metadata>

  <user-story>
    <as-a>DevOps engineer setting up the screenshot automation pipeline</as-a>
    <i-want>a dedicated IAM service account with scoped federation permissions</i-want>
    <so-that>the automation can access AWS Console for screenshots without using privileged credentials</so-that>
  </user-story>

  <acceptance-criteria>
    <criterion id="AC1.1" status="pending">
      <description>IAM user `ndx-screenshot-automation` created with `sts:GetFederationToken` permission only</description>
      <test-approach>Deploy CloudFormation stack and verify IAM user exists with correct permissions</test-approach>
    </criterion>
    <criterion id="AC1.2" status="pending">
      <description>Federation policy enforces read-only console access via explicit allowlist of Describe/List/Get actions</description>
      <test-approach>Unit test IAM policy document allows only read operations</test-approach>
    </criterion>
    <criterion id="AC1.3" status="pending">
      <description>Policy includes explicit deny for Create/Delete/Update/Put/Start/Stop/Invoke/iam:/organizations: actions</description>
      <test-approach>Unit test IAM policy denies all modification actions</test-approach>
    </criterion>
    <criterion id="AC1.4" status="pending">
      <description>Access keys generated and stored in GitHub Secrets</description>
      <test-approach>Verify CloudFormation outputs contain access key values; document GitHub Secrets setup</test-approach>
    </criterion>
    <criterion id="AC1.5" status="pending">
      <description>CloudTrail logging enabled for all federation sessions</description>
      <test-approach>Make test federation call and verify event appears in CloudTrail Event History</test-approach>
    </criterion>
    <criterion id="AC1.6" status="pending">
      <description>Documentation created at `docs/ops/federation-credentials.md` with 90-day rotation procedure</description>
      <test-approach>File exists with complete rotation procedure documentation</test-approach>
    </criterion>
  </acceptance-criteria>

  <tasks>
    <task id="1" description="Create CloudFormation template for IAM resources">
      <subtask id="1.1">Create cloudformation/screenshot-automation/iam.yaml</subtask>
      <subtask id="1.2">Define IAM User resource ndx-screenshot-automation</subtask>
      <subtask id="1.3">Define IAM Policy with sts:GetFederationToken permission</subtask>
      <subtask id="1.4">Define federation inline policy with explicit allowlist</subtask>
      <subtask id="1.5">Add explicit deny statement for modify/delete actions</subtask>
      <subtask id="1.6">Create IAM AccessKey resource</subtask>
      <subtask id="1.7">Add CloudFormation outputs for access key values</subtask>
      <subtask id="1.8">Add template metadata and description</subtask>
    </task>
    <task id="2" description="Write unit tests for IAM policy validation">
      <subtask id="2.1">Create tests/unit/iam-federation-policy.test.ts</subtask>
      <subtask id="2.2">Test that policy allows only read-only actions</subtask>
      <subtask id="2.3">Test that policy denies Create/Delete/Update actions</subtask>
      <subtask id="2.4">Test that policy denies iam:* and organizations:* actions</subtask>
      <subtask id="2.5">Test federation token scoping logic</subtask>
    </task>
    <task id="3" description="Deploy CloudFormation stack and verify">
      <subtask id="3.1">Deploy screenshot-automation-iam stack to AWS</subtask>
      <subtask id="3.2">Verify IAM user created successfully</subtask>
      <subtask id="3.3">Retrieve access key from CloudFormation outputs</subtask>
      <subtask id="3.4">Test GetFederationToken call with new credentials</subtask>
      <subtask id="3.5">Verify federation token cannot modify resources</subtask>
    </task>
    <task id="4" description="Configure GitHub Secrets documentation">
      <subtask id="4.1">Document AWS_FEDERATION_ACCESS_KEY_ID setup</subtask>
      <subtask id="4.2">Document AWS_FEDERATION_SECRET_ACCESS_KEY setup</subtask>
      <subtask id="4.3">Document AWS_REGION and AWS_ACCOUNT_ID secrets</subtask>
    </task>
    <task id="5" description="Verify CloudTrail logging">
      <subtask id="5.1">Make test federation call</subtask>
      <subtask id="5.2">Verify event appears in CloudTrail</subtask>
      <subtask id="5.3">Document expected CloudTrail event format</subtask>
    </task>
    <task id="6" description="Create credential rotation documentation">
      <subtask id="6.1">Create docs/ops/federation-credentials.md</subtask>
      <subtask id="6.2">Document 90-day rotation procedure</subtask>
      <subtask id="6.3">Document emergency rotation procedure</subtask>
      <subtask id="6.4">Document credential verification steps</subtask>
      <subtask id="6.5">Add rotation reminder calendar suggestion</subtask>
    </task>
  </tasks>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-sprint-0.md</path>
        <title>Sprint 0 Technical Specification</title>
        <section>Acceptance Criteria - S0.1</section>
        <snippet>IAM user ndx-screenshot-automation created with sts:GetFederationToken permission. Federation policy enforces read-only console access via explicit allowlist. Policy includes explicit deny for modification actions.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Definitions</title>
        <section>Story S0.1: AWS Federation Service Account Setup</section>
        <snippet>FR107: GetFederationToken with DurationSeconds: 3600 (1 hour max). NFR48: Explicit deny on all modify/delete actions. NFR49: Server-side only credentials.</snippet>
      </doc>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>FR107-FR115 Screenshot Automation</section>
        <snippet>AWS STS federation for console access. Server-side only credential handling. 1-hour session max with no refresh capability.</snippet>
      </doc>
    </docs>

    <code>
      <file>
        <path>cloudformation/scenarios/council-chatbot/template.yaml</path>
        <kind>cloudformation-template</kind>
        <symbol>AWS::CloudFormation::Template</symbol>
        <reason>Reference CloudFormation structure for consistency with existing templates</reason>
      </file>
      <file>
        <path>playwright.config.ts</path>
        <kind>config</kind>
        <symbol>defineConfig</symbol>
        <reason>Existing Playwright configuration to extend for console screenshots</reason>
      </file>
      <file>
        <path>tests/screenshot-capture.spec.ts</path>
        <kind>test</kind>
        <symbol>test.describe</symbol>
        <reason>Existing screenshot test patterns to follow</reason>
      </file>
    </code>

    <dependencies>
      <npm>
        <package name="@playwright/test" version="^1.49.0" dev="true">Used for E2E testing and screenshot capture</package>
        <package name="@aws-sdk/client-sts" version="^3.600.0" dev="true" required="true">AWS STS SDK for GetFederationToken - TO BE ADDED</package>
        <package name="ajv" version="^8.17.1" dev="true">JSON schema validation</package>
      </npm>
    </dependencies>
  </artifacts>

  <interfaces>
    <interface>
      <name>IAM Federation Policy</name>
      <kind>IAM Policy Document</kind>
      <signature>
        {
          "Version": "2012-10-17",
          "Statement": [
            { "Effect": "Allow", "Action": ["sts:GetFederationToken"], "Resource": "*" },
            { "Effect": "Allow", "Action": ["ec2:Describe*", "s3:List*", "s3:Get*", ...], "Resource": "*" },
            { "Effect": "Deny", "Action": ["iam:*", "*:Create*", "*:Delete*", ...], "Resource": "*" }
          ]
        }
      </signature>
      <path>cloudformation/screenshot-automation/iam.yaml</path>
    </interface>
    <interface>
      <name>CloudFormation Outputs</name>
      <kind>Stack Outputs</kind>
      <signature>
        FederationAccessKeyId: IAM user access key ID
        FederationSecretAccessKey: IAM user secret access key (with NoEcho)
        FederationUserArn: ARN of the IAM federation user
      </signature>
      <path>cloudformation/screenshot-automation/iam.yaml</path>
    </interface>
  </interfaces>

  <constraints>
    <constraint source="NFR48">Federation policy MUST have explicit deny on modify/delete actions</constraint>
    <constraint source="NFR49">Credentials MUST be server-side only - never exposed in client code</constraint>
    <constraint source="NFR50">Session max 1 hour, no refresh capability</constraint>
    <constraint source="tech-spec">Use allowlist (explicit allow) approach for IAM policy - safer than denylist</constraint>
    <constraint source="tech-spec">Access keys stored in GitHub Secrets initially (not AWS Secrets Manager for Sprint 0)</constraint>
    <constraint source="tech-spec">CloudFormation template must output access key values for manual GitHub Secrets setup</constraint>
    <constraint source="tech-spec">Never log credentials - use error codes only (FEDERATION_FAILED)</constraint>
  </constraints>

  <tests>
    <standards>
      Tests use Playwright for E2E testing. Unit tests should validate IAM policy logic without requiring AWS calls.
      Use Jest or Vitest for unit tests. Mock AWS SDK calls where needed.
      All tests must be deterministic and not require actual AWS credentials to pass unit tests.
    </standards>
    <locations>
      <location>tests/unit/</location>
      <location>tests/e2e/</location>
    </locations>
    <ideas>
      <idea ac="AC1.2, AC1.3">Unit test IAM policy JSON - verify allow/deny statements contain expected actions</idea>
      <idea ac="AC1.1">Integration test - deploy stack and verify IAM user exists via AWS CLI</idea>
      <idea ac="AC1.4">Integration test - verify CloudFormation outputs contain access key values</idea>
      <idea ac="AC1.5">Integration test - make federation call and check CloudTrail event history</idea>
      <idea ac="AC1.6">Documentation test - verify docs/ops/federation-credentials.md exists and contains required sections</idea>
    </ideas>
  </tests>

  <files-to-create>
    <file>cloudformation/screenshot-automation/iam.yaml</file>
    <file>tests/unit/iam-federation-policy.test.ts</file>
    <file>docs/ops/federation-credentials.md</file>
  </files-to-create>

  <files-to-modify>
    <file reason="Add @aws-sdk/client-sts dependency">package.json</file>
  </files-to-modify>
</story-context>
