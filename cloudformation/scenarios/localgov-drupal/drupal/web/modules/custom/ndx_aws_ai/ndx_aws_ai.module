<?php

/**
 * @file
 * NDX AWS AI module.
 *
 * Provides AWS SDK integration for AI-powered features including:
 * - Amazon Bedrock (Nova 2 Pro/Lite/Omni models)
 * - Amazon Polly (Neural TTS)
 * - Amazon Translate (75+ languages)
 * - Amazon Rekognition (DetectLabels)
 * - Amazon Textract (AnalyzeDocument)
 *
 * Story 3.1: ndx_aws_ai Module Foundation
 */

declare(strict_types=1);

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function ndx_aws_ai_help(string $route_name, RouteMatchInterface $route_match): ?string {
  switch ($route_name) {
    case 'help.page.ndx_aws_ai':
      $output = '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('The NDX AWS AI module provides integration with AWS AI services for the NDX:Try demonstration platform.') . '</p>';
      $output .= '<h4>' . t('Supported Services') . '</h4>';
      $output .= '<ul>';
      $output .= '<li>' . t('<strong>Amazon Bedrock:</strong> AI content generation using Nova 2 models') . '</li>';
      $output .= '<li>' . t('<strong>Amazon Polly:</strong> Neural text-to-speech in 7 languages') . '</li>';
      $output .= '<li>' . t('<strong>Amazon Translate:</strong> Translation to 75+ languages') . '</li>';
      $output .= '<li>' . t('<strong>Amazon Rekognition:</strong> Automatic image labeling for alt text') . '</li>';
      $output .= '<li>' . t('<strong>Amazon Textract:</strong> PDF document text extraction') . '</li>';
      $output .= '</ul>';
      $output .= '<h4>' . t('Configuration') . '</h4>';
      $output .= '<p>' . t('Configure AWS settings at <a href=":url">Administration > Configuration > System > AWS AI Settings</a>.', [
        ':url' => '/admin/config/system/ndx-aws-ai',
      ]) . '</p>';
      return $output;

    case 'ndx_aws_ai.settings':
      return '<p>' . t('Configure AWS region and test connectivity. Credentials are automatically obtained from the ECS task IAM role.') . '</p>';

    default:
      return NULL;
  }
}

/**
 * Implements hook_theme().
 *
 * Story 4.6: Listen to Page (TTS Button)
 * Story 4.7: Content Translation
 */
function ndx_aws_ai_theme(): array {
  return [
    'listen_to_page_player' => [
      'variables' => [
        'languages' => [],
        'default_language' => 'en-GB',
        'show_speed_control' => TRUE,
        'attributes' => [],
      ],
      'template' => 'listen-to-page-player',
    ],
    'content_translation_widget' => [
      'variables' => [
        'show_search' => TRUE,
        'show_priority_languages' => TRUE,
        'priority_languages' => [],
        'all_languages' => [],
        'attributes' => [],
      ],
      'template' => 'content-translation-widget',
    ],
  ];
}

/**
 * Implements hook_form_BASE_FORM_ID_alter() for node_form.
 *
 * Story 3.4: CKEditor AI Toolbar Plugin (Alternative Implementation)
 *
 * Adds AI assistant buttons above content editor fields.
 * This approach replaces the CKEditor5 plugin which requires webpack build.
 */
function ndx_aws_ai_form_node_form_alter(array &$form, \Drupal\Core\Form\FormStateInterface $form_state, string $form_id): void {
  // Check if user has permission to use AI features.
  $user = \Drupal::currentUser();
  if (!$user->hasPermission('use ndx aws ai')) {
    return;
  }

  // Add the AI toolbar buttons container.
  $form['ai_toolbar'] = [
    '#type' => 'container',
    '#attributes' => [
      'class' => ['ai-toolbar-buttons', 'clearfix'],
    ],
    '#weight' => -100,
    'title' => [
      '#type' => 'html_tag',
      '#tag' => 'span',
      '#value' => t('AI Assistant'),
      '#attributes' => [
        'class' => ['ai-toolbar-title'],
      ],
    ],
    'write_button' => [
      '#type' => 'button',
      '#value' => t('âœ¨ Generate Content'),
      '#attributes' => [
        'class' => ['ai-toolbar-button', 'ai-write-button', 'button', 'button--small'],
        'type' => 'button',
        'data-ai-action' => 'write',
      ],
      '#limit_validation_errors' => [],
    ],
    'simplify_button' => [
      '#type' => 'button',
      '#value' => t('ðŸ“– Simplify'),
      '#attributes' => [
        'class' => ['ai-toolbar-button', 'ai-simplify-button', 'button', 'button--small'],
        'type' => 'button',
        'data-ai-action' => 'simplify',
      ],
      '#limit_validation_errors' => [],
    ],
    'help_text' => [
      '#type' => 'html_tag',
      '#tag' => 'span',
      '#value' => t('Powered by Amazon Bedrock'),
      '#attributes' => [
        'class' => ['ai-toolbar-help'],
      ],
    ],
  ];

  // Attach the AI toolbar library.
  $form['#attached']['library'][] = 'ndx_aws_ai/ai_toolbar_buttons';
  $form['#attached']['library'][] = 'ndx_aws_ai/ai_writing_dialog';
  $form['#attached']['library'][] = 'ndx_aws_ai/ai_simplify_dialog';
}
