<?php

/**
 * @file
 * NDX AWS AI module.
 *
 * Provides AWS SDK integration for AI-powered features including:
 * - Amazon Bedrock (Nova 2 Pro/Lite/Omni models)
 * - Amazon Polly (Neural TTS)
 * - Amazon Translate (75+ languages)
 * - Amazon Rekognition (DetectLabels)
 * - Amazon Textract (AnalyzeDocument)
 *
 * Story 3.1: ndx_aws_ai Module Foundation
 */

declare(strict_types=1);

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function ndx_aws_ai_help(string $route_name, RouteMatchInterface $route_match): ?string {
  switch ($route_name) {
    case 'help.page.ndx_aws_ai':
      $output = '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('The NDX AWS AI module provides integration with AWS AI services for the NDX:Try demonstration platform.') . '</p>';
      $output .= '<h4>' . t('Supported Services') . '</h4>';
      $output .= '<ul>';
      $output .= '<li>' . t('<strong>Amazon Bedrock:</strong> AI content generation using Nova 2 models') . '</li>';
      $output .= '<li>' . t('<strong>Amazon Polly:</strong> Neural text-to-speech in 7 languages') . '</li>';
      $output .= '<li>' . t('<strong>Amazon Translate:</strong> Translation to 75+ languages') . '</li>';
      $output .= '<li>' . t('<strong>Amazon Rekognition:</strong> Automatic image labeling for alt text') . '</li>';
      $output .= '<li>' . t('<strong>Amazon Textract:</strong> PDF document text extraction') . '</li>';
      $output .= '</ul>';
      $output .= '<h4>' . t('Configuration') . '</h4>';
      $output .= '<p>' . t('Configure AWS settings at <a href=":url">Administration > Configuration > System > AWS AI Settings</a>.', [
        ':url' => '/admin/config/system/ndx-aws-ai',
      ]) . '</p>';
      return $output;

    case 'ndx_aws_ai.settings':
      return '<p>' . t('Configure AWS region and test connectivity. Credentials are automatically obtained from the ECS task IAM role.') . '</p>';

    default:
      return NULL;
  }
}

/**
 * Implements hook_theme().
 *
 * Story 4.6: Listen to Page (TTS Button)
 * Story 4.7: Content Translation
 */
function ndx_aws_ai_theme(): array {
  return [
    'listen_to_page_player' => [
      'variables' => [
        'languages' => [],
        'default_language' => 'en-GB',
        'show_speed_control' => TRUE,
        'attributes' => [],
      ],
      'template' => 'listen-to-page-player',
    ],
    'content_translation_widget' => [
      'variables' => [
        'show_search' => TRUE,
        'show_priority_languages' => TRUE,
        'priority_languages' => [],
        'all_languages' => [],
        'attributes' => [],
      ],
      'template' => 'content-translation-widget',
    ],
  ];
}

/**
 * Implements hook_form_BASE_FORM_ID_alter() for node_form.
 *
 * Story 3.4: CKEditor AI Toolbar Plugin (Alternative Implementation)
 *
 * Adds AI assistant buttons above content editor fields.
 * This approach replaces the CKEditor5 plugin which requires webpack build.
 */
function ndx_aws_ai_form_node_form_alter(array &$form, \Drupal\Core\Form\FormStateInterface $form_state, string $form_id): void {
  // Check if user has permission to use AI features.
  $user = \Drupal::currentUser();
  if (!$user->hasPermission('use ndx aws ai')) {
    return;
  }

  // Add the AI toolbar buttons container.
  $form['ai_toolbar'] = [
    '#type' => 'container',
    '#attributes' => [
      'class' => ['ai-toolbar-buttons', 'clearfix'],
    ],
    '#weight' => -100,
    'title' => [
      '#type' => 'html_tag',
      '#tag' => 'span',
      '#value' => t('AI Assistant'),
      '#attributes' => [
        'class' => ['ai-toolbar-title'],
      ],
    ],
    'write_button' => [
      '#type' => 'button',
      '#value' => t('âœ¨ Generate Content'),
      '#attributes' => [
        'class' => ['ai-toolbar-button', 'ai-write-button', 'button', 'button--small'],
        'type' => 'button',
        'data-ai-action' => 'write',
      ],
      '#limit_validation_errors' => [],
    ],
    'simplify_button' => [
      '#type' => 'button',
      '#value' => t('ðŸ“– Simplify'),
      '#attributes' => [
        'class' => ['ai-toolbar-button', 'ai-simplify-button', 'button', 'button--small'],
        'type' => 'button',
        'data-ai-action' => 'simplify',
      ],
      '#limit_validation_errors' => [],
    ],
    'help_text' => [
      '#type' => 'html_tag',
      '#tag' => 'span',
      '#value' => t('Powered by Amazon Bedrock'),
      '#attributes' => [
        'class' => ['ai-toolbar-help'],
      ],
    ],
  ];

  // Attach the AI toolbar library.
  $form['#attached']['library'][] = 'ndx_aws_ai/ai_toolbar_buttons';
  $form['#attached']['library'][] = 'ndx_aws_ai/ai_writing_dialog';
  $form['#attached']['library'][] = 'ndx_aws_ai/ai_simplify_dialog';
}

/**
 * Implements hook_form_FORM_ID_alter() for media_image_add_form.
 *
 * Story 4.5: Auto Alt-Text on Media Upload
 *
 * Attaches the alt-text generator library and adds generate button.
 */
function ndx_aws_ai_form_media_image_add_form_alter(array &$form, \Drupal\Core\Form\FormStateInterface $form_state, string $form_id): void {
  _ndx_aws_ai_attach_alt_text_generator($form);
}

/**
 * Implements hook_form_FORM_ID_alter() for media_image_edit_form.
 *
 * Story 4.5: Auto Alt-Text on Media Upload
 */
function ndx_aws_ai_form_media_image_edit_form_alter(array &$form, \Drupal\Core\Form\FormStateInterface $form_state, string $form_id): void {
  _ndx_aws_ai_attach_alt_text_generator($form, $form_state);
}

/**
 * Implements hook_form_alter() for media library forms.
 *
 * Story 4.5: Auto Alt-Text on Media Upload
 *
 * Attaches alt-text generator to media library add forms.
 */
function ndx_aws_ai_form_alter(array &$form, \Drupal\Core\Form\FormStateInterface $form_state, string $form_id): void {
  // Match media library upload forms.
  if (strpos($form_id, 'media_library_add_form') === 0) {
    _ndx_aws_ai_attach_alt_text_generator($form);
  }
}

/**
 * Attach the alt-text generator library and controls to a form.
 *
 * @param array $form
 *   The form array.
 * @param \Drupal\Core\Form\FormStateInterface|null $form_state
 *   Optional form state for edit forms.
 */
function _ndx_aws_ai_attach_alt_text_generator(array &$form, ?\Drupal\Core\Form\FormStateInterface $form_state = NULL): void {
  // Check if user has permission to use AI features.
  $user = \Drupal::currentUser();
  if (!$user->hasPermission('use ndx aws ai')) {
    return;
  }

  // Check if service is available.
  /** @var \Drupal\ndx_aws_ai\Service\AltTextGeneratorInterface $altTextGenerator */
  $altTextGenerator = \Drupal::service('ndx_aws_ai.alt_text_generator');
  if (!$altTextGenerator->isAvailable()) {
    return;
  }

  // Attach the library.
  $form['#attached']['library'][] = 'ndx_aws_ai/alt-text-generator';

  // For edit forms, add a regenerate button.
  if ($form_state !== NULL) {
    $entity = $form_state->getFormObject()->getEntity();
    if ($entity instanceof \Drupal\media\MediaInterface && $entity->hasField('field_media_image')) {
      $imageField = $entity->get('field_media_image');
      if (!$imageField->isEmpty()) {
        $fileId = $imageField->target_id;

        // Find the alt field and add button after it.
        if (isset($form['field_media_image']['widget'][0]['alt'])) {
          $form['field_media_image']['widget'][0]['alt']['#suffix'] = '
            <div class="alt-text-ai-controls">
              <button type="button" class="alt-text-generate-btn" data-file-id="' . $fileId . '" data-alt-field="#edit-field-media-image-0-alt">
                ' . t('Generate with AI') . '
              </button>
              <span class="ai-indicator" title="' . t('AI can generate accessible alt-text for this image') . '">' . t('AI Available') . '</span>
            </div>';
        }
      }
    }
  }
}
