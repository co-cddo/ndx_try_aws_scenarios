AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: |
  NDX:Try - QuickSight Dashboard Scenario
  Real Amazon QuickSight analytics and reporting with council performance data.
  Uses Lambda Custom Resource to create QuickSight resources (bypasses EarlyValidation).
  Version: 2.5.0 (Lambda-based QuickSight resource creation)

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Scenario Configuration
        Parameters:
          - Environment
          - SampleDataset
      - Label:
          default: Auto-Cleanup
        Parameters:
          - AutoCleanupHours

Parameters:
  Environment:
    Type: String
    Default: sandbox
    AllowedValues:
      - sandbox
      - development
      - production
    Description: Deployment environment (controls lifecycle rules and retention)

  SampleDataset:
    Type: String
    Default: council-metrics
    Description: Sample dataset identifier for council performance metrics

  AutoCleanupHours:
    Type: Number
    Default: 2
    MinValue: 1
    MaxValue: 24
    Description: Hours until automatic resource cleanup in sandbox environment

Resources:
  # ============================================================================
  # S3 BUCKET FOR QUICKSIGHT DATA
  # ============================================================================
  DataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'ndx-quicksight-data-${AWS::AccountId}-${AWS::Region}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: AutoCleanupSandbox
            Status: Enabled
            ExpirationInDays: 7
            NoncurrentVersionExpirationInDays: 1
      VersioningConfiguration:
        Status: Enabled
      Tags:
        - Key: Project
          Value: ndx-try
        - Key: Scenario
          Value: quicksight-dashboard
        - Key: AutoCleanup
          Value: 'true'

  # ============================================================================
  # S3 BUCKET POLICY - ALLOW QUICKSIGHT ACCESS
  # ============================================================================
  DataBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref DataBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowQuickSightServiceAccess
            Effect: Allow
            Principal:
              Service: quicksight.amazonaws.com
            Action:
              - s3:GetObject
              - s3:GetObjectVersion
              - s3:ListBucket
              - s3:GetBucketLocation
            Resource:
              - !GetAtt DataBucket.Arn
              - !Sub '${DataBucket.Arn}/*'
            Condition:
              StringEquals:
                aws:SourceAccount: !Ref AWS::AccountId

  # ============================================================================
  # IAM ROLE FOR QUICKSIGHT LAMBDA
  # ============================================================================
  QuickSightLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'ndx-quicksight-lambda-${AWS::Region}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: S3DataAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:GetObject
                  - s3:DeleteObject
                  - s3:ListBucket
                  - s3:GetBucketLocation
                Resource:
                  - !GetAtt DataBucket.Arn
                  - !Sub '${DataBucket.Arn}/*'
        - PolicyName: QuickSightFullAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - quicksight:*
                Resource: '*'
        - PolicyName: IAMPassRole
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - iam:PassRole
                Resource: !GetAtt QuickSightS3AccessRole.Arn
      Tags:
        - Key: Project
          Value: ndx-try
        - Key: Scenario
          Value: quicksight-dashboard

  # ============================================================================
  # IAM ROLE FOR QUICKSIGHT S3 ACCESS
  # ============================================================================
  QuickSightS3AccessRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'ndx-quicksight-s3-access-${AWS::Region}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: quicksight.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: S3ReadAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                  - s3:ListBucket
                  - s3:GetBucketLocation
                Resource:
                  - !GetAtt DataBucket.Arn
                  - !Sub '${DataBucket.Arn}/*'
      Tags:
        - Key: Project
          Value: ndx-try
        - Key: Scenario
          Value: quicksight-dashboard

  # ============================================================================
  # QUICKSIGHT RESOURCE CREATOR LAMBDA
  # ============================================================================
  QuickSightCreatorFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'ndx-quicksight-creator-${AWS::Region}'
      Description: Creates QuickSight DataSource, DataSet and Dashboard via SDK
      Runtime: python3.12
      Handler: index.handler
      Role: !GetAtt QuickSightLambdaRole.Arn
      Timeout: 300
      MemorySize: 512
      Environment:
        Variables:
          DATA_BUCKET: !Ref DataBucket
          ACCOUNT_ID: !Ref AWS::AccountId
          REGION: !Ref AWS::Region
          S3_ROLE_ARN: !GetAtt QuickSightS3AccessRole.Arn
      Code:
        ZipFile: |
          import json
          import boto3
          import random
          import urllib3
          from datetime import datetime, timedelta
          import os
          import time

          s3 = boto3.client('s3')
          quicksight = boto3.client('quicksight')
          http = urllib3.PoolManager()

          SERVICE_AREAS = [
              'Waste Collection', 'Planning Applications', 'Housing',
              'Council Tax', 'Highways', 'Environmental Health',
              'Benefits', 'Customer Services', 'Parking'
          ]

          REGIONS = [
              'London', 'South East', 'South West', 'West Midlands',
              'East Midlands', 'North West', 'North East', 'Yorkshire'
          ]

          def generate_council_data():
              """Generate 12 months of council performance data"""
              rows = []
              for month_offset in range(12):
                  month_date = datetime.now() - timedelta(days=30 * month_offset)
                  month_str = month_date.strftime('%Y-%m')
                  for region in REGIONS:
                      council_name = f'Demo {region} Council'
                      for service in SERVICE_AREAS:
                          cases_received = random.randint(100, 500)
                          resolution_rate = random.uniform(0.75, 0.95)
                          cases_resolved = int(cases_received * resolution_rate)
                          avg_response_hours = round(random.uniform(12, 72), 1)
                          satisfaction_score = round(random.uniform(3.5, 4.8), 2)
                          rows.append({
                              'council_name': council_name,
                              'region': region,
                              'service_area': service,
                              'month': month_str,
                              'cases_received': cases_received,
                              'cases_resolved': cases_resolved,
                              'avg_response_hours': avg_response_hours,
                              'satisfaction_score': satisfaction_score
                          })
              return rows

          def write_csv_to_s3(bucket, key, data):
              """Write data as CSV to S3"""
              if not data:
                  raise ValueError("No data to write")
              csv_buffer = []
              fieldnames = data[0].keys()
              csv_buffer.append(','.join(fieldnames))
              for row in data:
                  csv_buffer.append(','.join(str(row[field]) for field in fieldnames))
              csv_content = '\n'.join(csv_buffer)
              s3.put_object(Bucket=bucket, Key=key, Body=csv_content.encode('utf-8'), ContentType='text/csv')
              return len(data)

          def create_manifest(bucket, region, data_key):
              """Create QuickSight manifest file"""
              return {
                  "fileLocations": [{"URIs": [f"https://{bucket}.s3.{region}.amazonaws.com/{data_key}"]}],
                  "globalUploadSettings": {"format": "CSV", "delimiter": ",", "textqualifier": "\"", "containsHeader": True}
              }

          def send_cfn_response(event, context, status, data=None, physical_id=None, reason=None):
              """Send CloudFormation custom resource response"""
              response_body = {
                  'Status': status,
                  'Reason': reason or f'See CloudWatch Log Stream: {context.log_stream_name}',
                  'PhysicalResourceId': physical_id or context.log_stream_name,
                  'StackId': event['StackId'],
                  'RequestId': event['RequestId'],
                  'LogicalResourceId': event['LogicalResourceId'],
                  'Data': data or {}
              }
              json_response = json.dumps(response_body).encode('utf-8')
              headers = {'Content-Type': 'application/json', 'Content-Length': str(len(json_response))}
              try:
                  http.request('PUT', event['ResponseURL'], body=json_response, headers=headers)
              except Exception as e:
                  print(f"Failed to send response: {str(e)}")

          def delete_quicksight_resources(account_id, region):
              """Delete QuickSight resources"""
              dashboard_id = f'ndx-council-dashboard-{region}'
              dataset_id = f'ndx-council-data-set-{region}'
              datasource_id = f'ndx-council-data-source-{region}'

              try:
                  quicksight.delete_dashboard(AwsAccountId=account_id, DashboardId=dashboard_id)
                  print(f"Deleted dashboard: {dashboard_id}")
              except Exception as e:
                  print(f"Could not delete dashboard: {e}")

              try:
                  quicksight.delete_data_set(AwsAccountId=account_id, DataSetId=dataset_id)
                  print(f"Deleted dataset: {dataset_id}")
              except Exception as e:
                  print(f"Could not delete dataset: {e}")

              try:
                  quicksight.delete_data_source(AwsAccountId=account_id, DataSourceId=datasource_id)
                  print(f"Deleted datasource: {datasource_id}")
              except Exception as e:
                  print(f"Could not delete datasource: {e}")

          def create_quicksight_resources(account_id, region, bucket, s3_role_arn):
              """Create QuickSight DataSource, DataSet, and Dashboard via SDK"""
              datasource_id = f'ndx-council-data-source-{region}'
              dataset_id = f'ndx-council-data-set-{region}'
              dashboard_id = f'ndx-council-dashboard-{region}'

              # Delete existing resources first (idempotency)
              delete_quicksight_resources(account_id, region)
              time.sleep(2)

              # Create DataSource
              print("Creating DataSource...")
              quicksight.create_data_source(
                  AwsAccountId=account_id,
                  DataSourceId=datasource_id,
                  Name='NDX Council Performance Data',
                  Type='S3',
                  DataSourceParameters={
                      'S3Parameters': {
                          'ManifestFileLocation': {
                              'Bucket': bucket,
                              'Key': 'manifests/council-data-manifest.json'
                          },
                          'RoleArn': s3_role_arn
                      }
                  },
                  Tags=[{'Key': 'Project', 'Value': 'ndx-try'}]
              )
              print(f"Created DataSource: {datasource_id}")

              datasource_arn = f'arn:aws:quicksight:{region}:{account_id}:datasource/{datasource_id}'

              # Create DataSet
              print("Creating DataSet...")
              quicksight.create_data_set(
                  AwsAccountId=account_id,
                  DataSetId=dataset_id,
                  Name='NDX Council Performance DataSet',
                  ImportMode='SPICE',
                  PhysicalTableMap={
                      'CouncilDataPhysical': {
                          'S3Source': {
                              'DataSourceArn': datasource_arn,
                              'InputColumns': [
                                  {'Name': 'council_name', 'Type': 'STRING'},
                                  {'Name': 'region', 'Type': 'STRING'},
                                  {'Name': 'service_area', 'Type': 'STRING'},
                                  {'Name': 'month', 'Type': 'STRING'},
                                  {'Name': 'cases_received', 'Type': 'STRING'},
                                  {'Name': 'cases_resolved', 'Type': 'STRING'},
                                  {'Name': 'avg_response_hours', 'Type': 'STRING'},
                                  {'Name': 'satisfaction_score', 'Type': 'STRING'}
                              ],
                              'UploadSettings': {
                                  'ContainsHeader': True,
                                  'Delimiter': ',',
                                  'Format': 'CSV',
                                  'TextQualifier': 'DOUBLE_QUOTE'
                              }
                          }
                      }
                  },
                  LogicalTableMap={
                      'CouncilDataLogical': {
                          'Alias': 'Council Performance Data',
                          'Source': {'PhysicalTableId': 'CouncilDataPhysical'},
                          'DataTransforms': [
                              {'CastColumnTypeOperation': {'ColumnName': 'cases_received', 'NewColumnType': 'INTEGER'}},
                              {'CastColumnTypeOperation': {'ColumnName': 'cases_resolved', 'NewColumnType': 'INTEGER'}},
                              {'CastColumnTypeOperation': {'ColumnName': 'avg_response_hours', 'NewColumnType': 'DECIMAL'}},
                              {'CastColumnTypeOperation': {'ColumnName': 'satisfaction_score', 'NewColumnType': 'DECIMAL'}}
                          ]
                      }
                  },
                  Tags=[{'Key': 'Project', 'Value': 'ndx-try'}]
              )
              print(f"Created DataSet: {dataset_id}")

              dataset_arn = f'arn:aws:quicksight:{region}:{account_id}:dataset/{dataset_id}'

              # Wait for SPICE ingestion to start
              time.sleep(5)

              # Create Dashboard with simple definition
              print("Creating Dashboard...")
              quicksight.create_dashboard(
                  AwsAccountId=account_id,
                  DashboardId=dashboard_id,
                  Name='NDX Council Performance Dashboard',
                  Definition={
                      'DataSetIdentifierDeclarations': [
                          {'Identifier': 'CouncilData', 'DataSetArn': dataset_arn}
                      ],
                      'Sheets': [
                          {
                              'SheetId': 'main-dashboard',
                              'Name': 'Council Performance Overview',
                              'ContentType': 'INTERACTIVE',
                              'Visuals': [
                                  {
                                      'KPIVisual': {
                                          'VisualId': 'kpi-total-cases',
                                          'Title': {'Visibility': 'VISIBLE', 'FormatText': {'PlainText': 'Total Cases Received'}},
                                          'ChartConfiguration': {
                                              'FieldWells': {
                                                  'Values': [{
                                                      'NumericalMeasureField': {
                                                          'FieldId': 'total-cases-field',
                                                          'Column': {'DataSetIdentifier': 'CouncilData', 'ColumnName': 'cases_received'},
                                                          'AggregationFunction': {'SimpleNumericalAggregation': 'SUM'}
                                                      }
                                                  }]
                                              }
                                          }
                                      }
                                  },
                                  {
                                      'BarChartVisual': {
                                          'VisualId': 'bar-cases-by-service',
                                          'Title': {'Visibility': 'VISIBLE', 'FormatText': {'PlainText': 'Cases by Service Area'}},
                                          'ChartConfiguration': {
                                              'FieldWells': {
                                                  'BarChartAggregatedFieldWells': {
                                                      'Category': [{
                                                          'CategoricalDimensionField': {
                                                              'FieldId': 'service-category-field',
                                                              'Column': {'DataSetIdentifier': 'CouncilData', 'ColumnName': 'service_area'}
                                                          }
                                                      }],
                                                      'Values': [{
                                                          'NumericalMeasureField': {
                                                              'FieldId': 'cases-value-field',
                                                              'Column': {'DataSetIdentifier': 'CouncilData', 'ColumnName': 'cases_received'},
                                                              'AggregationFunction': {'SimpleNumericalAggregation': 'SUM'}
                                                          }
                                                      }]
                                                  }
                                              },
                                              'Orientation': 'HORIZONTAL',
                                              'BarsArrangement': 'CLUSTERED'
                                          }
                                      }
                                  }
                              ]
                          }
                      ]
                  },
                  Tags=[{'Key': 'Project', 'Value': 'ndx-try'}],
                  VersionDescription='v1.0 - Initial dashboard'
              )
              print(f"Created Dashboard: {dashboard_id}")

              dashboard_url = f'https://{region}.quicksight.aws.amazon.com/sn/dashboards/{dashboard_id}'
              return {
                  'DataSourceId': datasource_id,
                  'DataSetId': dataset_id,
                  'DashboardId': dashboard_id,
                  'DashboardUrl': dashboard_url
              }

          def handler(event, context):
              """Lambda handler for Custom Resource"""
              print(f"Event: {json.dumps(event)}")

              bucket = os.environ['DATA_BUCKET']
              account_id = os.environ['ACCOUNT_ID']
              region = os.environ['REGION']
              s3_role_arn = os.environ['S3_ROLE_ARN']

              data_key = 'data/council-metrics.csv'
              manifest_key = 'manifests/council-data-manifest.json'
              request_type = event.get('RequestType')

              try:
                  if request_type == 'Delete':
                      print("Deleting QuickSight resources...")
                      delete_quicksight_resources(account_id, region)
                      # Delete S3 data
                      try:
                          s3.delete_object(Bucket=bucket, Key=data_key)
                          s3.delete_object(Bucket=bucket, Key=manifest_key)
                      except Exception as e:
                          print(f"Could not delete S3 files: {e}")
                      send_cfn_response(event, context, 'SUCCESS',
                          physical_id=f'{bucket}-quicksight-resources',
                          reason='Resources deleted')
                      return

                  # Create or Update
                  print("Generating sample data...")
                  data = generate_council_data()
                  row_count = write_csv_to_s3(bucket, data_key, data)
                  print(f"Generated {row_count} rows of data")

                  manifest = create_manifest(bucket, region, data_key)
                  s3.put_object(Bucket=bucket, Key=manifest_key,
                      Body=json.dumps(manifest, indent=2).encode('utf-8'),
                      ContentType='application/json')
                  print("Created manifest file")

                  # Create QuickSight resources
                  print("Creating QuickSight resources...")
                  qs_result = create_quicksight_resources(account_id, region, bucket, s3_role_arn)

                  response_data = {
                      'RowCount': row_count,
                      'DataKey': data_key,
                      'ManifestKey': manifest_key,
                      'BucketName': bucket,
                      'DataSourceId': qs_result['DataSourceId'],
                      'DataSetId': qs_result['DataSetId'],
                      'DashboardId': qs_result['DashboardId'],
                      'DashboardUrl': qs_result['DashboardUrl']
                  }

                  send_cfn_response(event, context, 'SUCCESS',
                      data=response_data,
                      physical_id=f'{bucket}-quicksight-resources',
                      reason=f'Created QuickSight dashboard: {qs_result["DashboardId"]}')

              except Exception as e:
                  print(f"Error: {str(e)}")
                  import traceback
                  traceback.print_exc()
                  send_cfn_response(event, context, 'FAILED', reason=str(e)[:250])
      Tags:
        - Key: Project
          Value: ndx-try
        - Key: Scenario
          Value: quicksight-dashboard

  # ============================================================================
  # CLOUDWATCH LOG GROUP
  # ============================================================================
  QuickSightCreatorLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${QuickSightCreatorFunction}'
      RetentionInDays: 7
      Tags:
        - Key: Project
          Value: ndx-try
        - Key: Scenario
          Value: quicksight-dashboard

  # ============================================================================
  # CUSTOM RESOURCE - CREATE QUICKSIGHT RESOURCES
  # ============================================================================
  QuickSightResources:
    Type: AWS::CloudFormation::CustomResource
    DependsOn:
      - DataBucket
      - DataBucketPolicy
      - QuickSightCreatorLogGroup
      - QuickSightS3AccessRole
    Properties:
      ServiceToken: !GetAtt QuickSightCreatorFunction.Arn
      ServiceTimeout: 300
      Timestamp: !Sub '${AWS::StackName}-v5'

# ============================================================================
# OUTPUTS
# ============================================================================
Outputs:
  DataBucket:
    Description: S3 bucket name for QuickSight data
    Value: !Ref DataBucket
    Export:
      Name: !Sub '${AWS::StackName}-DataBucket'

  DataBucketArn:
    Description: S3 bucket ARN for QuickSight data
    Value: !GetAtt DataBucket.Arn
    Export:
      Name: !Sub '${AWS::StackName}-DataBucketArn'

  QuickSightS3RoleArn:
    Description: IAM Role ARN for QuickSight S3 access
    Value: !GetAtt QuickSightS3AccessRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-QuickSightS3RoleArn'

  DataSourceId:
    Description: QuickSight DataSource ID
    Value: !GetAtt QuickSightResources.DataSourceId
    Export:
      Name: !Sub '${AWS::StackName}-DataSourceId'

  DataSetId:
    Description: QuickSight DataSet ID
    Value: !GetAtt QuickSightResources.DataSetId
    Export:
      Name: !Sub '${AWS::StackName}-DataSetId'

  DashboardId:
    Description: QuickSight Dashboard ID
    Value: !GetAtt QuickSightResources.DashboardId
    Export:
      Name: !Sub '${AWS::StackName}-DashboardId'

  DashboardUrl:
    Description: QuickSight Dashboard Console URL
    Value: !GetAtt QuickSightResources.DashboardUrl
    Export:
      Name: !Sub '${AWS::StackName}-DashboardUrl'

  ManifestUri:
    Description: Full S3 URI for QuickSight manifest
    Value: !Sub 's3://${DataBucket}/manifests/council-data-manifest.json'
    Export:
      Name: !Sub '${AWS::StackName}-ManifestUri'

  DataUri:
    Description: Full S3 URI for council metrics data
    Value: !Sub 's3://${DataBucket}/data/council-metrics.csv'
    Export:
      Name: !Sub '${AWS::StackName}-DataUri'

  ScenarioInfo:
    Description: NDX:Try scenario information
    Value: !Sub |
      {
        "scenario": "quicksight-dashboard",
        "version": "2.5.0",
        "story": "Lambda-based QuickSight Creation",
        "environment": "${Environment}",
        "dataset": "${SampleDataset}",
        "services": ["S3", "Lambda", "QuickSight", "CloudFormation"],
        "features": ["KPI Visuals", "Bar Charts", "SDK-based Creation"]
      }
